---
title: "AWS Lambda に外部ライブラリを導入する"
emoji: "📦"
tags: ["AWS", "Lambda", "Python"]
published: true
published_at: "2025-05-25"
source: "zenn"
source_url: "https://zenn.dev/manamana/articles/4992e199d08d1b"
html_body: "true"
---

# どんな人向けの記事か

- AWS Lambda に Python ライブラリをインストールして使いたい人
- AWS Lambda で Import error に悩まされている人
- Mac を使っている方（Windows の場合も同様の手順でできると思いますが、適宜読み替えてください）

# 手順

## 大まかな流れ

1. ローカル環境に、AWS Lambda に設定した Python バージョンと同じ Python 環境を用意する
2. ローカル環境で、必要なライブラリを `pip install` する（一部ライブラリは後述する whl をインストールしてから`pip install`する）
3. ローカル環境で、必要なライブラリをすべて詰め込んだフォルダを zip 化する
4. AWS Lambda で、レイヤーを追加し zip ファイルをアップロードする

## 1. ローカル環境で、AWS Lambda に設定した Python バージョンと同じ Python 環境を用意する

今回は Python 3.13 環境を作ります
こちら ↓ の記事を参考に、pyenv をインストールして Python 3.13 をインストールしてください
https://zenn.dev/hotani3/articles/setup-python-on-macos

インストールが完了したら、`Python -V` （V は大文字）と打って `3.13.2` のように表示されれば OK です！

## 2. ローカル環境で、必要なライブラリをインストールする

今回は JWT 認証を実装するため `PyJWT` と `cryptography` というライブラリをインストールする前提で進めます
他のライブラリを使用したい場合は、適宜読み替えてください！

まずはこちら ↓ のサイトで、インストールしたいライブラリを検索します
https://pypi.org/

ライブラリのページへ行き、**ファイルをダウンロード** をクリックすると対応するプラットフォームごとのファイル一覧が表示されます

:::message alert
pypi のサイトでインストールしたいライブラリを検索し、ライブラリページの表示内容によって以下 2 つの手順に分岐します！

**`manylinux` 表示がない場合 ↓**
![none_manylinux](/images/none_manylinux.png)

**`manylinux` 表示がある場合 ↓**
![manylinux](/images/manylinux.png)
:::

:::message
**A. pypi の該当ライブラリページのファイルをダウンロードセクションで、`manylinux` という表示がない場合**

1. ライブラリインストール用のディレクトリを適当に作成する（`mkdir Sandbox` などでカレントディレクトリに Sandbox ディレクトリを作成できる）
2. `cd Sandbox` で作成したディレクトリに移動し、`mkdir python` （ここは python という名前のディレクトリを作成すること）
3. whl をインストールする手順をスキップし、`pip install -t python/` で python ディレクトリにライブラリをインストールする
   :::

:::message
**B. pypi の該当ライブラリページのファイルをダウンロードセクションで、`manylinux` という表示がある場合**

1. ライブラリインストール用のディレクトリを適当に作成する（`mkdir Sandbox` などでカレントディレクトリに Sandbox ディレクトリを作成できる）
2. `cd Sandbox` で作成したディレクトリに移動し、`mkdir python` （ここは python という名前のディレクトリを作成すること）
3. 表示されているファイルの中で、`manylinux`、`x86-64`、`Python 3.13`（あれば）に対応している `.whl` ファイルをダウンロード
4. ダウンロードされた `.whl` ファイルを、カレントディレクトリ（この場合は/Sandbox）に移動させる

   （現在のディレクトリ構成は以下のようになっているはず）

![directory_image](/images/directory.png)

5. 以下のコマンドを打ち、python ディレクトリへライブラリをインストールする
   （↓ は cryptography をインストールする例）

```shell
$ pip --python 3.13 install \
   --platform manylinux2014_x86_64 \
   --target=python \
   --implementation cp \
   --only-binary=:all: --upgrade \
   cryptography
```

:::

## 3. あとは zip ファイル化する

```shell
$ zip -r layer.zip python
```

ちなみに zip ファイルの名前は `layer.zip` でなくても、なんでも良い

## 4. AWS Lambda にレイヤーを追加する

以下の手順で進めていく

1. AWS コンソールの Lambda > その他のリソース > レイヤー へ移動する
2. レイヤーを作成 をクリック
3. 名前（なんでも OK）、説明 などを入力して .zip ファイルをアップロードする（先ほど作成した zip ファイル）
4. 作成 をクリックし、レイヤーを作成する
5. Lambda の コードセクションの最下部から、レイヤーの追加 をクリック
6. カスタムレイヤーを選択し、先ほど作成したレイヤーを追加
7. Lambda にレイヤーが追加されていることを確認し、完了

### 参考 ↓

https://qiita.com/Bashi50/items/1f72a93dbde23de55dda#%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%82%92%E8%BF%BD%E5%8A%A0